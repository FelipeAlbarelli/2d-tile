
<script lang="ts">
    import { indexToCord  } from '../store'
    import { Stage, Layer, Rect , Image } from 'svelte-konva';
    import Tile from './Tile.svelte'
    import { Layer as LayerType } from 'konva/lib/Layer'
    import { Stage as StegeKonva } from 'konva/lib/Stage'
    import { createEventDispatcher, getContext, onMount, setContext } from 'svelte';
    import { createEmptyMatrix, type  Cord, type InitialMatrixOptions , nullCord } from './grid-helpers';
    import { nullTileState, type TileCoreData } from './tile-helpers';
	import SelectibleRect from './SelectibleRect.svelte';
  
    export let gap : number
    export let padding = 12;
    export let tileSetDim = 16;
    export let dim = {col : 2 , row : 2}
    export let initialMatrix :InitialMatrixOptions = 'none'
    export let matrix = createEmptyMatrix( dim.col * dim.row , initialMatrix)
    export let scale : number

    export const matrixSetTile = (cord: Cord , value : number) => {
      matrix[cord.index] = value
    }

    let tileDragStart : null | TileCoreData = null
    let tileDragEnd : null | TileCoreData = null
    let mouseIsDown = false;
    $: width =  ((tileSetDim + (gap * 2) ) * scale * dim.col )  +  (padding * 2);
    $: height = ((tileSetDim + (gap * 2) ) * scale * dim.row ) + padding * 2

    /**
     * Tile que est√° sendo hover pelo mouse agora
     */
    export let activeTile : TileCoreData = nullTileState

    const despachante = createEventDispatcher<{
      confirm  : TileCoreData,
      context  : TileCoreData,
    }>()

    let stage : StegeKonva;
    let layerStage : LayerType

    let selectedTile : Cord | null;

    $: selectedTileBot = mouseIsDown ? activeTile.inGrid : selectedTile

    const hanlderContext = (e: MouseEvent) => {
      despachante('context', activeTile );
      tileDragStart = null;
    }

    const handleClick = (e : MouseEvent) => {
      despachante('confirm' , activeTile)
    }


  $: console.log({
    mouseIsDown
  })
</script>


<!-- svelte-ignore a11y-no-static-element-interactions -->
<!-- svelte-ignore a11y-click-events-have-key-events -->
<div 
    on:contextmenu|preventDefault={hanlderContext}
    on:click={handleClick}
    on:mouseup={ e => {tileDragEnd = activeTile ; mouseIsDown = false; }}
    class="grid-cont"
    >

    <Stage
        on:mouseleave={ e => activeTile = nullTileState }
        bind:ref={stage}
         config={{ width:width, height: height , scale : {x: 1, y : 1} }} > 
      <Layer
        bind:handle={layerStage}
        config={{
          imageSmoothingEnabled: false ,
          y : 8,
          x : 8,
          scaleX : scale,
          scaleY : scale 
        }}
      >


      {#each matrix as tileSheetIndex , index }
      {@const cords = indexToCord({index, totalCols : dim.col , totalRows : dim.row})}
      {@const thisTileData = { inGrid : cords, tileSheetIndex, } }
        <Tile
            on:mouseenter={ e => activeTile = {
              inGrid : cords,
              tileSheetIndex,
            }}
            on:mousedown={ e =>{ selectedTile = cords; mouseIsDown = true  }}
            dimensions={tileSetDim}
            tileSetIndex={tileSheetIndex}
            gap={gap}
            gridPosition={{ col : cords.col , row : cords.row }}
        />
      {/each}
      <slot />

        <SelectibleRect
          topLeft={selectedTile}
          botRight={selectedTileBot}
          {gap} tileSetDim={16}
        ></SelectibleRect>
        <SelectibleRect
          color={'blue'}
          topLeft={selectedTile}
          botRight={tileDragEnd?.inGrid}
          {gap} tileSetDim={16}
        ></SelectibleRect>
      </Layer>
    </Stage>
  </div>


  <style lang="scss" >
  
.grid-cont {
    display: flex;
    padding: 12px;
    // border: 2px solid white;
    // width: 100%;
}
  
</style>